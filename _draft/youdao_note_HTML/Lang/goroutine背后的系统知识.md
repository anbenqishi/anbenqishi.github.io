::: {#sidebar}
::: {#outline}
:::
:::

::: {#page-container}
::: {#pf1 .pf .w0 .h0 page-no="1"}
::: {.pc .pc1 .w0 .h0}
![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+AAAAXLCAIAAAAz/kHlAAAACXBIWXMAABYlAAAWJQFJUiTwAAAceUlEQVR42uzdMWtTXRzA4XNfrlPmioNDHF3SySE6uDg5i+IHEOpgRBw6BBQL+QBawcHBqQULpXTQRVfJKsnq0FF66dZMFo7DwUtImr61Er25fZ5BYnJuaf+p8ONwvMlijAEAAKiG/4wAAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAwD+Tn2ZR1u7V7yeP/a63HwCAqrGDDgAAFZLFGE0BAAAqwg46AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAFRQfppFWbtnUqcR+11DAADgT9hBBwCACslijKYAAAAVYQcdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINAB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AACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgW4EAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAADHy40AAFhQWbtnCKXY7xpCTX6xY4ymAAAAFeGICwAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECg/y3Ly8tZlmVZNhwOT1jw8ePH6UtKy8vLa2trR0dH5gkAUGNZjNEU5qooiosXL6bHL168ePbs2awFh4eHjUZj4pIJ9+/f39zcNFUAgLqygz5379+/Lx9vb2/PWnDr1q1U5+UzrVYrxhhjPDw8/PDhw6VLlwwTAECg86fevn2b+juEMBgMiqKYWNDr9UIIT548mbjkwYMH6a+NRuP27dsPHz4MIUxfDgCAQOe0iqIYDAZlc4cQPn36NL5gOBx+//49hHDz5s2JS+7duze+8uDgIISwv79vqgAAAp0zKo+vNJvNtIn+7t278QU7OzthxvmWpaWlctmXL19evXoVQtjd3TVVAACBzhmljfN0fCX9+fnz59FoVC548+ZNOO58y+rqavnMcDi8c+dOCGF9fb3ZbJoqAIBA5yzKwyrp+Mq1a9fS81+/fi3Le9b5lm/fvm1ubj5+/DjLslarFULY2NhYWVkxVQCAesuNYH4mbs+ytLTUarUGg8HW1taNGzfCr/MtnU5n4nxLCOH58+fl11lfX19ZWclzbxYAQP3ZQZ+j8fMtSboxSzpNHn6db7l79+7EJZ1OZ2Njo9PppCd3d3fVOQDAOeGDiuZl+uOHQgh7e3tXrlwJIaRzLOnsyo8fP1J/T1+ytraWttL39/fH/88oAAB1ZQd9XtLu+PjtWUIIzWYzfd7Qzs5Oeb6l3B2fvuTp06fpwfinHQEAINA5Y6CPn29J0ucNbW9vp08VHT/fMn1Jo9FIN2d0d0UAgHPCEZe5GA6H6fjK+PmWiZeS8nzLrEtev3796NGjY78UAAD1Ywd9LqY/fqh09erV8vH4+ZZZl5R3YCxvzggAgEDn98w63xJCyPO8vD3LyedbJoJ+a2vLYAEAas8Rl7nY29sLIVy+fPnY2yOORqOiKCYWnHBJeqnRaLiRCwCAQGdSURSj0ejYlzQ0AAAC/a86Ojq6cOHCrFc7nc7Lly9NCQAq2j3t3mJ9w7Hf9aacw7dDoP+e0Wh0wh0Pr1+/3mw2TQkAAIEOAAB14C4uAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAQG3kp1mUtXt1/fljv+uXAACA6shijKYAAAAV4YgLAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0gJ/t1jEBAAAAQLD+rQWxRXABAAw6AAAYdAAAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGXQIAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAI4C77WzGebSAToAAAAASUVORK5CYII=){.bi
.x0 .y0 .w1 .h1}

::: {.c .x0 .y1 .w1 .h2}
::: {.t .m0 .x1 .h3 .y2 .ff1 .fs0 .fc0 .sc0 .ls0 .ws0}
Go语言[从诞生到普及已经三年了，先行者大都是Web开发的背景，也有了一些普及型的书籍，可系统开]{.fc1}
:::

::: {.t .m0 .x1 .h3 .y3 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
发背景的人在学习这些书籍的时候，总有语焉不详的感觉，网上也有若干流传甚广的文章，可其中或多或
:::

::: {.t .m0 .x1 .h3 .y4 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
少总有些与事实不符的技术描述。希望这篇文章能为比较缺少系统编程背景的Web开发人员介绍一下
:::

::: {.t .m0 .x1 .h3 .y5 .ff1 .fs0 .fc0 .sc0 .ls0 .ws0}
goroutine[背后的系统知识。]{.fc1}
:::

::: {.t .m0 .x1 .h4 .y6 .ff2 .fs1 .fc1 .sc0 .ls0 .ws0}
1.操作系统与运行库
:::

::: {.t .m0 .x1 .h3 .y7 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
对于普通的电脑用户来说，能理解应用程序是运行在操作系统之上就足够了，可对于开发者，我们还需要
:::

::: {.t .m0 .x1 .h3 .y8 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
了解我们写的程序是如何在操作系统之上运行起来的，操作系统如何为应用程序提供服务，这样我们才
:::

::: {.t .m0 .x1 .h3 .y9 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
能分清楚哪些服务是操作系统提供的，而哪些服务是由我们所使用的语言的运行库提供的。
:::

::: {.t .m0 .x1 .h3 .ya .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
除了内存管理、文件管理、进程管理、外设管理等等内部模块以外，操作系统还提供了许多外部接口供应
:::

::: {.t .m0 .x1 .h3 .yb .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
用程序使用，这些接口就是所谓的"系统调用"。从DOS时代开始，系统调用就是通过软中断的形式来
:::

::: {.t .m0 .x1 .h3 .yc .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
提供，也就是著名的[INT21]{.fc0}，程序把需要调用的功能编号放入AH寄存器，把参数放入其他指定的寄存
:::

::: {.t .m0 .x1 .h3 .yd .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
器，然后调用INT21，中断返回后，程序从指定的寄存器(通常是AL)里取得返回值。这样的做法一直到奔
:::

::: {.t .m0 .x1 .h3 .ye .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
腾2也就是P6出来之前都没有变，譬如windows通过INT2E提供系统调用，Linux则是INT80，只不过后
:::

::: {.t .m0 .x1 .h3 .yf .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
来的寄存器比以前大一些，而且可能再多一层跳转表查询。后来，Intel和AMD分别提供了效率更高的
:::

::: {.t .m0 .x1 .h3 .y10 .ff1 .fs0 .fc0 .sc0 .ls0 .ws0}
SYSENTER/SYSEXIT和SYSCALL/SYSRET[指令来代替之前的中断方式，略过了耗时的特权级别检查以及]{.fc1}
:::

::: {.t .m0 .x1 .h3 .y11 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
寄存器压栈出栈的操作，直接完成从RING3代码段到RING0代码段的转换。
:::

::: {.t .m0 .x1 .h3 .y12 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
系统调用都提供什么功能呢？用操作系统的名字加上对应的中断编号到谷歌上一查就可以得到完整的列表
:::

::: {.t .m0 .x1 .h3 .y13 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
([Windows]{.fc0},[Linux]{.fc0})，这个列表就是操作系统和应用程序之间沟通的协议，如果需要超出此协议的功能，
:::

::: {.t .m0 .x1 .h3 .y14 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
我们就只能在自己的代码里去实现，譬如，对于内存管理，操作系统只提供进程级别的内存段的管理，譬
:::

::: {.t .m0 .x1 .h3 .y15 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
如Windows的[virtualmemory]{.fc0}系列，或是Linux的[brk]{.fc0}，操作系统不会去在乎应用程序如何为新建对象分
:::

::: {.t .m0 .x1 .h3 .y16 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
配内存，或是如何做垃圾回收，这些都需要应用程序自己去实现。如果超出此协议的功能无法自己实现，
:::

::: {.t .m0 .x1 .h3 .y17 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
那我们就说该操作系统不支持该功能，举个例子，Linux在2.6之前是不支持多线程的，无论如何在程序
:::

::: {.t .m0 .x1 .h3 .y18 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
里模拟，我们都无法做出多个可以同时运行的并符合POSIX1003.1c语义标准的调度单元。
:::

::: {.t .m0 .x1 .h3 .y19 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
可是，我们写程序并不需要去调用中断或是SYSCALL指令，这是因为操作系统提供了一层封装，在
:::

::: {.t .m0 .x1 .h3 .y1a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
Windows上，它是NTDLL.DLL，也就是常说的NativeAPI，我们不但不需要去直接调用INT2E或
:::

::: {.t .m0 .x1 .h3 .y1b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
SYSCALL，准确的说，我们不能直接去调用INT2E或SYSCALL，因为Windows并没有公开其调用规范，
:::

::: {.t .m0 .x1 .h3 .y1c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
直接使用INT2E或SYSCALL无法保证未来的兼容性。在Linux上则没有这个问题，系统调用的列表都是公
:::

::: {.t .m0 .x1 .h3 .y1d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
开的，而且Linus非常看重兼容性，不会去做任何更改，glibc里甚至专门提供了[syscall(2)]{.fc0}来方便用户直
:::

::: {.t .m0 .x1 .h3 .y1e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
接用编号调用，不过，为了解决glibc和内核之间不同版本兼容性带来的麻烦，以及为了提高某些调用的
:::

::: {.t .m0 .x1 .h3 .y1f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
效率(譬如[ ]{._
._0}gettimeofday)，Linux上还是对部分系统调用做了一层封装，就是[VDSO]{.fc0}(早期叫[linux-]{.fc0}
:::

::: {.t .m0 .x1 .h3 .y20 .ff1 .fs0 .fc0 .sc0 .ls0 .ws0}
gate.so[)。]{.fc1}
:::

::: {.t .m0 .x1 .h3 .y21 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
可是，我们写程序也很少直接调用NTDLL或者VDSO，而是通过更上一层的封装，这一层处理了参数准备
:::

::: {.t .m0 .x1 .h3 .y22 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
和返回值格式转换、以及出错处理和错误代码转换，这就是我们所使用语言的运行库，对于C语言，
:::

::: {.t .m0 .x1 .h3 .y23 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
Linux上是glibc，Windows上是kernel32(或调用msvcrt)，对于其他语言，譬如Java，则是JRE，这
:::

::: {.t .m0 .x1 .h3 .y24 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
些"其他语言"的运行库通常最终还是调用glibc或kernel32。
:::

::: {.t .m0 .x1 .h3 .y25 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
"运行库"这个词其实不止包括用于和编译后的目标执行程序进行链接的库文件，也包括了脚本语言或字
:::

::: {.t .m0 .x1 .h3 .y26 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
节码解释型语言的运行环境，譬如Python，C\#的CLR，Java的JRE。
:::

::: {.t .m0 .x1 .h3 .y27 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
对系统调用的封装只是运行库的很小一部分功能，运行库通常还提供了诸如字符串处理、数学计算、常用
:::

::: {.t .m0 .x1 .h3 .y28 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
数据结构容器等等不需要操作系统支持的功能，同时，运行库也会对操作系统支持的功能提供更易用更高
:::

::: {.t .m0 .x1 .h3 .y29 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
级的封装，譬如带缓存和格式的IO、线程池。
:::
:::

[](http://golang.org/){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:56.003025px;bottom:770.239010px;width:35.267773px;height:14.257210px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://golang.org/doc/effective_go.html#goroutines){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:56.003025px;bottom:716.211790px;width:49.524960px;height:14.257200px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://stanislavs.org/helppc/int_21.html){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:150.550674px;bottom:576.641480px;width:33.016646px;height:14.257200px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://wiki.osdev.org/Sysenter){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:56.003025px;bottom:504.605160px;width:192.096815px;height:14.257140px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://j00ru.vexillium.org/ntapi/){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:59.754917px;bottom:450.577910px;width:46.523449px;height:14.257200px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://syscalls.kernelgrok.com/){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:111.531013px;bottom:450.577910px;width:26.263237px;height:14.257200px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://undocumented.ntinternals.net/UserMode/Undocumented%20Functions/Memory%20Management/Virtual%20Memory/NtAllocateVirtualMemory.html){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:123.537064px;bottom:414.559780px;width:73.537066px;height:14.257180px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://linux.die.net/man/2/brk){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:286.369140px;bottom:414.559780px;width:16.508300px;height:14.257180px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://linux.die.net/man/2/syscall){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:424.438720px;bottom:270.487180px;width:45.022680px;height:14.257200px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://lwn.net/Articles/446528/){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:432.692870px;bottom:234.468990px;width:29.264770px;height:14.257210px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://www.trilithium.com/johan/2005/08/linux-gate/){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:56.003025px;bottom:216.459900px;width:472.738245px;height:32.266300px;background-color:rgba(255,255,255,0.000001);"}
:::
:::

::: {.pi data="{\"ctm\":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}"}
:::
:::

::: {#pf2 .pf .w0 .h0 page-no="2"}
::: {.pc .pc2 .w0 .h0}
![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+AAAAXLCAIAAAAz/kHlAAAACXBIWXMAABYlAAAWJQFJUiTwAAAY8ElEQVR42uzawQ2AMAwEwTiiKWrjTW2UdfSAZMkSMx3k/NlHKskCAABm2CYAAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQTQAAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKCbAAAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQDcBAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBbgIAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAbQ4TtKrz/uGr81xODwDwMSCTWAEAAIbwxQUAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6CbgbbcOBAAAAAAE7U+9SFEEAICgAwAAgg4AAIIOAAAIOgAACDoAACDoAAAg6AAAgKADAICgAwAAgg4AAIIOAAAIOgAAIOgAACDoAACAoAMAgKADAACCDgAAgg4AAAg6AAAIOgAAIOgAACDoAACAoAMAgKADAACCDgAACDoAAAg6AAAg6AAAIOgAAICgAwCAoAMAAIIOAACCDgAACDoAAAg6AAAg6AAAIOgAAICgAwAAgg4AAIIOAAAIOgAACDoAACDoAAAg6AAAgKADAICgAwAAgg4AAIIOAAAIOgAACDoAACDoAACAoAMAgKADAACCDgAAgg4AAAg6AAAIOgAAIOgAACDoAACAoAMAgKADAACCDgAAgg4AAAg6AABQNXQAFJH717sXAAAAAElFTkSuQmCC){.bi
.x0 .y0 .w1 .h1}

::: {.c .x0 .y1 .w1 .h2}
::: {.t .m0 .x1 .h3 .y2a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
所以，在我们说"某某语言新增了某某功能"的时候，通常是这么几种可能：
:::

::: {.t .m0 .x2 .h3 .y2b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
4.支持新的语义或语法，从而便于我们描述和解决问题。譬如Java的泛型、Annotation、lambda
:::

::: {.t .m0 .x2 .h3 .y2c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
表达式。
:::

::: {.t .m0 .x2 .h3 .y2d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
5.提供了新的工具或类库，减少了我们开发的代码量。譬如Python2.7的argparse
:::

::: {.t .m0 .x2 .h3 .y2e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
6.对系统调用有了更良好更全面的封装，使我们可以做到以前在这个语言环境里做不到或很难做到
:::

::: {.t .m0 .x2 .h3 .y2f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的事情。譬如JavaNIO
:::

::: {.t .m0 .x1 .h3 .y30 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
但任何一门语言，包括其运行库和运行环境，都不可能创造出操作系统不支持的功能，Go语言也是这
:::

::: {.t .m0 .x1 .h3 .y31 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
样，不管它的特性描述看起来多么炫丽，那必然都是其他语言也可以做到的，只不过Go提供了更方便更
:::

::: {.t .m0 .x1 .h3 .y32 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
清晰的语义和支持，提高了开发的效率。
:::

::: {.t .m0 .x1 .h4 .y33 .ff2 .fs1 .fc1 .sc0 .ls0 .ws0}
2.并发与并行(ConcurrencyandParallelism)
:::

::: {.t .m0 .x1 .h3 .y34 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
并发是指程序的逻辑结构。非并发的程序就是一根竹竿捅到底，只有一个逻辑控制流，也就是顺序执行的
:::

::: {.t .m0 .x1 .h3 .y35 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
(Sequential)程序，在任何时刻，程序只会处在这个逻辑控制流的某个位置。而如果某个程序有多个独立
:::

::: {.t .m0 .x1 .h3 .y36 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的逻辑控制流，也就是可以同时处理(deal)多件事情，我们就说这个程序是并发的。这里的"同时"，并
:::

::: {.t .m0 .x1 .h3 .y37 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
不一定要是真正在时钟的某一时刻(那是运行状态而不是逻辑结构)，而是指：如果把这些逻辑控制流画成
:::

::: {.t .m0 .x1 .h3 .y38 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
时序流程图，它们在时间线上是可以重叠的。
:::

::: {.t .m0 .x1 .h3 .y39 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
并行是指程序的运行状态。如果一个程序在某一时刻被多个CPU流水线同时进行处理，那么我们就说这个
:::

::: {.t .m0 .x1 .h3 .y3a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
程序是以并行的形式在运行。（严格意义上讲，我们不能说某程序是"并行"的，因为"并行"不是描
:::

::: {.t .m0 .x1 .h3 .y3b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
述程序本身，而是描述程序的运行状态，但这篇小文里就不那么咬文嚼字，以下说到"并行"的时候，就
:::

::: {.t .m0 .x1 .h3 .y3c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
是指代"以并行的形式运行"）显然，并行一定是需要硬件支持的。
:::

::: {.t .m0 .x1 .h3 .y3d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
而且不难理解：
:::

::: {.t .m0 .x2 .h3 .y3e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
5.并发是并行的必要条件，如果一个程序本身就不是并发的，也就是只有一个逻辑控制流，那么我
:::

::: {.t .m0 .x2 .h3 .y3f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
们不可能让其被并行处理。
:::

::: {.t .m0 .x2 .h3 .y40 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
6.并发不是并行的充分条件，一个并发的程序，如果只被一个CPU流水线进行处理(通过分时)，那
:::

::: {.t .m0 .x2 .h3 .y41 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
么它就不是并行的。
:::

::: {.t .m0 .x2 .h3 .y42 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
7.并发只是更符合现实问题本质的表达方式，并发的最初目的是简化代码逻辑，而不是使程序运行
:::

::: {.t .m0 .x2 .h3 .y43 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的更快；
:::

::: {.t .m0 .x1 .h3 .y44 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
这几段略微抽象，我们可以用一个最简单的例子来把这些概念实例化：用C语言写一个最简单的
:::

::: {.t .m0 .x1 .h3 .y45 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
HelloWorld，它就是非并发的，如果我们建立多个线程，每个线程里打印一个HelloWorld，那么这个
:::

::: {.t .m0 .x1 .h3 .y46 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
程序就是并发的，如果这个程序运行在老式的单核CPU上，那么这个并发程序还不是并行的，如果我们
:::

::: {.t .m0 .x1 .h3 .y47 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
用多核多CPU且支持多任务的操作系统来运行它，那么这个并发程序就是并行的。
:::

::: {.t .m0 .x1 .h3 .y48 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
还有一个略微复杂的例子，更能说明并发不一定可以并行，而且并发不是为了效率，就是Go语言例子里
:::

::: {.t .m0 .x1 .h3 .y49 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
计算素数的[sieve.go]{.fc0}。我们从小到大针对每一个因子启动一个代码片段，如果当前验证的数能被当前因
:::

::: {.t .m0 .x1 .h3 .y4a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
子除尽，则该数不是素数，如果不能，则把该数发送给下一个因子的代码片段，直到最后一个因子也无
:::

::: {.t .m0 .x1 .h3 .y4b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
法除尽，则该数为素数，我们再启动一个它的代码片段，用于验证更大的数字。这是符合我们计算素数的
:::

::: {.t .m0 .x1 .h3 .y4c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
逻辑的，而且每个因子的代码处理片段都是相同的，所以程序非常的简洁，但它无法被并行，因为每个
:::

::: {.t .m0 .x1 .h3 .y4d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
片段都依赖于前一个片段的处理结果和输出。
:::

::: {.t .m0 .x1 .h3 .y4e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
并发可以通过以下方式做到：
:::

::: {.t .m0 .x2 .h3 .y4f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
4.显式地定义并触发多个代码片段，也就是逻辑控制流，由应用程序或操作系统对它们进行调度。
:::

::: {.t .m0 .x2 .h3 .y50 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
它们可以是独立无关的，也可以是相互依赖需要交互的，譬如上面提到的素数计算，其实它也是
:::

::: {.t .m0 .x2 .h3 .y51 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
个经典的生产者和消费者的问题：两个逻辑控制流A和B，A产生输出，当有了输出后，B取得A的
:::
:::

[](http://golang.org/doc/play/sieve.go){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:108.529495px;bottom:204.453860px;width:41.270798px;height:14.257200px;background-color:rgba(255,255,255,0.000001);"}
:::
:::

::: {.pi data="{\"ctm\":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}"}
:::
:::

::: {#pf3 .pf .w0 .h0 page-no="3"}
::: {.pc .pc3 .w0 .h0}
![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+AAAAXLCAIAAAAz/kHlAAAACXBIWXMAABYlAAAWJQFJUiTwAAAeSUlEQVR42uzdy29U1x3A8d99zMMeGxscCBAa8kAhIYs6BKVKK5VlN62UTRftX9Ko6/4dXTS7rKquu0DpSwGSVKpAAVIS58HTYIM9ntc9pwunJIQ0hWSQUPT57Dz3yFf6zearo3PvFDnnAAAAHg2lEQAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOhGAAAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoBsBAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AAHgo6vtZVLz6O5MCHk357781BAC+T+ygAwDAI6TIOZsCAAA8IuygAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAgG31/Sw6ceLEQ7r98ePHfQcAAHCHHXQAAHiE1Pe/dOq73Q9vYx4AAL7/gR4Rb7zxxoPeoKqq1157rdPplKXdegAAmGqg5xw/ePKpPXv35/+3MCKuXPr04gcXRqPhm2++uby8fOTIkaqqiqIwdAAAmFag5/mFnXufeCrlyN8U6bkoYnOzP2kmS0tLvV7vzJkzTdMcOnRobm5OowMAwHQCPSJGk+gP87jJTfqfa4oi12UMxzkiDh48ePjw4ZMnT506dbppmuXl5bquzR0AAKYQ6DmnJsWoieE4N02OiJl2udgryrLIKa/1c3+YtgO9VcX2grqu5+bmjhx5od1unz179ubNm8eOHVtcXLSPDgAA93qwBzdzzk3KkybGk9ykKMuYacfCbLmzVy72ytlOVGU0KcaTmDTRpJxz3tjYWF1dret63769c3NzFy5cOH369Gg0MnoAALjXAz8kekenjscXq163rMqIiKKIpbmq2yqurDVbo4iIlPNk0pw7d25lZSUimqbZ2tpqmub8+fOvvPKjTqdj+gAA8B0DPeeIsojFXjnbjl63aNefn1QpiqJVRycVRREppckkzy8sPXdkuYxUlkVEFBFFEZubG6vXrjreAgAAUwr0nKsy5mfK2XbkHMPxXc+KjiY5pdyknHPasbh7/769rbpobQd6EWVVXPp05dbamrkDAMB0Aj1yjJu4vDbO6Wves5hyHo5zjshRjJvYGDRVWVT/DfROqxqMcpOyuQMAwHQCPeecUt4aptEkfePSGEWepCiKXBYREWVZpFyOm+1jMgAAwLQCPXJKOX3jRniKiLsXVGVRlnnSRFW3IhxCBwCAqQT6F398m/st7dp18KfHZ2dnjB4AAKYR6DlHjpzj7oMqOUdu8jjlpoiiKMqqaBV3v2S9iNyp88J8b+dcXVWl0QMAwBQCPSLuDfQckXPaam6PUr+MqlV2u9WOqrirwtt1uWdHPT9bOt0CAABTC/ScI0eklFJKETFsbm9MVq8M3r/SP9sUwxRNEUWrnJmtlh7rPLu3+3y77HXqzu6F1s65stvKpVegAwDAVAM9b2+fj5vRKG2ujT++Oji3snn6k813ijKKsoiIKjoz1eJ699IkDfbNPr3Y3f/YQnfXfDsihsPR2vra0q5ddV2bPgAAfMWDnQW/84xojhg0ty8Pzl7YeOtf63+6OjpTVF+8mqWJUb+5/nH/7bdX/9DtrR4+ML/Q+zzHr6/e+Otf/jYYDIweAADu9S1+qCg3ebIxvnZ18P6H/X9cG76/2azmmBR3nV3JKZoDi0++9PhPnn7sB71ONyKG48nq2uZnV26ura9vH48BAAC+a6CnnMZp68bo4mdb//x0693N5tq9yzrVzEJ31/Ljr/7iuV+3q07KqT/q3xoM10bl5qiaTNQ5AABMJ9Bj1Axuj66t9E+t9N8eNOtfu+zJhUM/P/SrZ3Y+3yrbETGY9N/66M+X1289u/BqDj8kCgAAUwv0fG3w4fXbH10dnN9orqeYfGXBXHvHC0vLy3t+/PzS8o7uYkScv37mzOo7710+eXswqsrZztbsOA0kOgAATCXQ05XbFzbqG7cG14pJUUXryxc7rc7+3lM/e/aXL+5+OSLGk/FoPHrvg5N/XPl9RMzUOy7eODXXX4pUhF10AAD47oE+Go3ict25vrg7dSZ5/OVLVVW89PLyDw8d27fjwPYnFz/69+l3T39289ITm8sRURV1WXXHeVKNK3MHAIApBHpKKfplnTt1dL5yqWqXBxaeeW7Pi3c+2VjfXPngk/G4mY/dX/yHMpctYwcAgGkE+uuv/+b+Fx89evTo0aNGDAAADyXQT5w4YV4AAPBQFd56CAAAj47SCAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQjAAAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0I0AAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgD8p107NgEABIIgiGBT1mZsbZZ1NmBipOBMCQcPGzyAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAA+rJgCAT5Q2jHBFZjcCB6eaxAoAAPAILy4AACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABgbwEnBrl927HGLAAAAABJRU5ErkJggg==){.bi
.x0 .y0 .w1 .h1}

::: {.c .x0 .y52 .w1 .h5}
::: {.t .m0 .x2 .h3 .y53 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
输出进行处理。线程只是实现并发的其中一个手段，除此之外，运行库或是应用程序本身也有多
:::

::: {.t .m0 .x2 .h3 .y54 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
种手段来实现并发，这是下节的主要内容。
:::

::: {.t .m0 .x2 .h3 .y55 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
5.隐式地放置多个代码片段，在系统事件发生时触发执行相应的代码片段，也就是事件驱动的方
:::

::: {.t .m0 .x2 .h3 .y56 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
式，譬如某个端口或管道接收到了数据(多路IO的情况下)，再譬如进程接收到了某个信号
:::

::: {.t .m0 .x2 .h3 .y57 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
(signal)。
:::

::: {.t .m0 .x1 .h3 .y58 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
并行可以在四个层面上做到：
:::

::: {.t .m0 .x2 .h3 .y59 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
6.多台机器。自然我们就有了多个CPU流水线，譬如Hadoop集群里的MapReduce任务。
:::

::: {.t .m0 .x2 .h3 .y5a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
7.多CPU。不管是真的多颗CPU还是多核还是超线程，总之我们有了多个CPU流水线。
:::

::: {.t .m0 .x2 .h3 .y5b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
8.单CPU核里的ILP(Instruction-levelparallelism)，指令级并行。通过复杂的制造工艺和对指令
:::

::: {.t .m0 .x2 .h3 .y5c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的解析以及分支预测和乱序执行，现在的CPU可以在单个时钟周期内执行多条指令，从而，即使是
:::

::: {.t .m0 .x2 .h3 .y5d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
非并发的程序，也可能是以并行的形式执行。
:::

::: {.t .m0 .x2 .h3 .y5e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
9.单指令多数据(Singleinstruction,multipledata.SIMD)，为了多媒体数据的处理，现在的CPU
:::

::: {.t .m0 .x2 .h3 .y5f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的指令集支持单条指令对多条数据进行操作。
:::

::: {.t .m0 .x1 .h3 .y60 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
其中，1牵涉到分布式处理，包括数据的分布和任务的同步等等，而且是基于网络的。3和4通常是编译器
:::

::: {.t .m0 .x1 .h3 .y61 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
和CPU的开发人员需要考虑的。这里我们说的并行主要针对第2种：单台机器内的多核CPU并行。
:::

::: {.t .m0 .x1 .h3 .y62 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
关于并发与并行的问题，Go语言的作者RobPike专门就此写过一个幻灯片：
:::

::: {.t .m0 .x1 .h3 .y63 .ff1 .fs0 .fc0 .sc0 .ls0 .ws0}
http://talks.golang.org/2012/waza.slide
:::

::: {.t .m0 .x1 .h3 .y64 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
在CMU那本著名的《ComputerSystems:AProgrammer'sPerspective》里的这张图也非常直观清
:::

::: {.t .m0 .x1 .h3 .y65 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
晰：
:::

::: {.t .m0 .x1 .h4 .y66 .ff2 .fs1 .fc1 .sc0 .ls0 .ws0}
3.线程的调度
:::

::: {.t .m0 .x1 .h3 .y67 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
上一节主要说的是并发和并行的概念，而线程是最直观的并发的实现，这一节我们主要说操作系统如何让
:::

::: {.t .m0 .x1 .h3 .y68 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
多个线程并发的执行，当然在多CPU的时候，也就是并行的执行。我们不讨论进程，进程的意义是"隔离
:::

::: {.t .m0 .x1 .h3 .y69 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的执行环境"，而不是"单独的执行序列"。
:::

::: {.t .m0 .x1 .h3 .y6a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
我们首先需要理解IA-32CPU的指令控制方式，这样才能理解如何在多个指令序列(也就是逻辑控制流)之
:::

::: {.t .m0 .x1 .h3 .y6b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
间进行切换。CPU通过CS:EIP寄存器的值确定下一条指令的位置，但是CPU并不允许直接使用MOV指令
:::

::: {.t .m0 .x1 .h3 .y6c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
来更改EIP的值，必须通过JMP系列指令、CALL/RET指令、或INT中断指令来实现代码的跳转；在指令序
:::

::: {.t .m0 .x1 .h3 .y6d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
列间切换的时候，除了更改EIP之外，我们还要保证代码可能会使用到的各个寄存器的值，尤其是栈指针
:::

::: {.t .m0 .x1 .h3 .y6e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
SS:ESP，以及EFLAGS标志位等，都能够恢复到目标指令序列上次执行到这个位置时候的状态。
:::

::: {.t .m0 .x1 .h3 .y6f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
线程是操作系统对外提供的服务，应用程序可以通过系统调用让操作系统启动线程，并负责随后的线程调
:::

::: {.t .m0 .x1 .h3 .y70 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
度和切换。我们先考虑单颗单核CPU，操作系统内核与应用程序其实是也是在共享同一个CPU，当EIP在
:::

::: {.t .m0 .x1 .h3 .y71 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
应用程序代码段的时候，内核并没有控制权，内核并不是一个进程或线程，内核只是以保护模式运行的，
:::

::: {.t .m0 .x1 .h3 .y72 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
代码段权限为RING0的内存中的程序，只有当产生中断或是应用程序呼叫系统调用的时候，控制权才转
:::

::: {.t .m0 .x1 .h3 .y73 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
移到内核，在内核里，所有代码都在同一个地址空间，为了给不同的线程提供服务，内核会为每一个线
:::

::: {.t .m0 .x1 .h3 .y74 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
程建立一个内核堆栈，这是线程切换的关键。通常，内核会在时钟中断里或系统调用返回前(考虑到性
:::

::: {.t .m0 .x1 .h3 .y75 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
能，通常是在不频繁发生的系统调用返回前)，对整个系统的线程进行调度，计算当前线程的剩余时间
:::

::: {.t .m0 .x1 .h3 .y76 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
片，如果需要切换，就在"可运行"的线程队列里计算优先级，选出目标线程后，则保存当前线程的运
:::

::: {.t .m0 .x1 .h3 .y77 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
行环境，并恢复目标线程的运行环境，其中最重要的，就是切换堆栈指针ESP，然后再把EIP指向目标线
:::

::: {.t .m0 .x1 .h3 .y78 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
程上次被移出CPU时的指令。Linux内核在实现线程切换时，耍了个花枪，它并不是直接JMP，而是先把
:::

::: {.t .m0 .x1 .h3 .y79 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
ESP切换为目标线程的内核栈，把目标线程的代码地址压栈，然后JMP到[\_\_switch\_to()]{.fc0}，相当于伪造了一
:::
:::

[](http://talks.golang.org/2012/waza.slide){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:56.003025px;bottom:488.096800px;width:197.349465px;height:14.257200px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://lxr.linux.no/linux+v3.8.2/arch/x86/kernel/process_32.c#L248){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:389.170930px;bottom:63.382813px;width:63.782160px;height:14.257080px;background-color:rgba(255,255,255,0.000001);"}
:::
:::

::: {.pi data="{\"ctm\":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}"}
:::
:::

::: {#pf4 .pf .w0 .h0 page-no="4"}
::: {.pc .pc4 .w0 .h0}
![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+AAAAXLCAIAAAAz/kHlAAAACXBIWXMAABYlAAAWJQFJUiTwAAAZIUlEQVR42uzYwQ3CMBBEURa5Kdfmc2pzWUMBXEBKogW9V8IcrO+tJA8AAKCHpwkAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAcJNhAgCAc9U8jPAuexnhEy7oAADQ6YOXxAoAANCECzoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0E0AAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAAWhkm6KzmYYRvZS8j4KHAywP8Lhd0AABopJJYAQAAmnBBBwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAS6CQAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AABwkWEC4L/VPIzARbKXEYDTuaADAEAjlcQKAADQhAs6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINBNAAAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoJsAAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AODVbh0SAAAAAAj6/9oTRphgEsCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEGXAAAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAAswDkHCON2uA5DwAAAABJRU5ErkJggg==){.bi
.x0 .y0 .w1 .h1}

::: {.c .x0 .y7a .w1 .h6}
::: {.t .m0 .x1 .h3 .y7b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
个CALL[switch\_to()指令，然后，在]{.ff2}switch\_to()的最后使用RET指令返回，这样就把栈里的目标线程的
:::

::: {.t .m0 .x1 .h3 .y7c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
代码地址放入了EIP，接下来CPU就开始执行目标线程的代码了，其实也就是上次停在[switch\_to]{.fc0}这个宏展
:::

::: {.t .m0 .x1 .h3 .y7d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
开的地方。
:::

::: {.t .m0 .x1 .h3 .y7e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
这里需要补充几点：(1)虽然IA-32提供了TSS(TaskStateSegment)，试图简化操作系统进行线程调度
:::

::: {.t .m0 .x1 .h3 .y7f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的流程，但由于其效率低下，而且并不是通用标准，不利于移植，所以主流操作系统都没有去利用TSS。
:::

::: {.t .m0 .x1 .h3 .y80 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
更严格的说，其实还是用了TSS，因为只有通过TSS才能把堆栈切换到内核堆栈指针SS0:ESP0，但除此之
:::

::: {.t .m0 .x1 .h3 .y81 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
外的TSS的功能就完全没有被使用了。(2)线程从用户态进入内核的时候，相关的寄存器以及用户态代码
:::

::: {.t .m0 .x1 .h3 .y82 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
段的EIP已经保存了一次，所以，在上面所说的内核态线程切换时，需要保存和恢复的内容并不多。(3)
:::

::: {.t .m0 .x1 .h3 .y83 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
以上描述的都是抢占式(preemptively)的调度方式，内核以及其中的硬件驱动也会在等待外部资源可用的
:::

::: {.t .m0 .x1 .h3 .y84 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
时候主动调用[schedule()]{.fc0}，用户态的代码也可以通过[sched\_yield()]{.fc0}系统调用主动发起调度，让出CPU。
:::

::: {.t .m0 .x1 .h3 .y85 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
现在我们一台普通的PC或服务里通常都有多颗CPU(physicalpackage)，每颗CPU又有多个核
:::

::: {.t .m0 .x1 .h3 .y86 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
(processorcore)，每个核又可以支持超线程(twologicalprocessorsforeachcore)，也就是逻辑处理
:::

::: {.t .m0 .x1 .h3 .y87 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
器。每个逻辑处理器都有自己的一套完整的寄存器，其中包括了CS:EIP和SS:ESP，从而，以操作系统和
:::

::: {.t .m0 .x1 .h3 .y88 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
应用的角度来看，每个逻辑处理器都是一个单独的流水线。在多处理器的情况下，线程切换的原理和流
:::

::: {.t .m0 .x1 .h3 .y89 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
程其实和单处理器时是基本一致的，内核代码只有一份，当某个CPU上发生时钟中断或是系统调用时，
:::

::: {.t .m0 .x1 .h3 .y8a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
该CPU的CS:EIP和控制权又回到了内核，内核根据调度策略的结果进行线程切换。但在这个时候，如果我
:::

::: {.t .m0 .x1 .h3 .y8b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
们的程序用线程实现了并发，那么操作系统可以使我们的程序在多个CPU上实现并行。
:::

::: {.t .m0 .x1 .h3 .y8c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
这里也需要补充两点：(1)多核的场景里，各个核之间并不是完全对等的，譬如在同一个核上的两个超线
:::

::: {.t .m0 .x1 .h3 .y8d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
程是共享L1/L2缓存的；在有NUMA支持的场景里，每个核访问内存不同区域的延迟是不一样的；所以，
:::

::: {.t .m0 .x1 .h3 .y8e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
多核场景里的线程调度又引入了"调度域"([schedulingdomains]{.fc0})的概念，但这不影响我们理解线程切
:::

::: {.t .m0 .x1 .h3 .y8f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
换机制。(2)多核的场景下，中断发给哪个CPU？软中断(包括除以0，缺页异常，INT指令)自然是在触发
:::

::: {.t .m0 .x1 .h3 .y90 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
该中断的CPU上产生，而硬中断则又分两种情况，一种是每个CPU自己产生的中断，譬如时钟，这是每
:::

::: {.t .m0 .x1 .h3 .y91 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
个CPU处理自己的，还有一种是外部中断，譬如IO，可以通过APIC来指定其送给哪个CPU；因为调度程
:::

::: {.t .m0 .x1 .h3 .y92 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
序只能控制当前的CPU，所以，如果IO中断没有进行均匀的分配的话，那么和IO相关的线程就只能在某
:::

::: {.t .m0 .x1 .h3 .y93 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
些CPU上运行，导致CPU负载不均，进而影响整个系统的效率。
:::

::: {.t .m0 .x1 .h4 .y94 .ff2 .fs1 .fc1 .sc0 .ls0 .ws0}
4.并发编程框架
:::

::: {.t .m0 .x1 .h3 .y95 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
以上大概介绍了一个用多线程来实现并发的程序是如何被操作系统调度以及并行执行(在有多个逻辑处理
:::

::: {.t .m0 .x1 .h3 .y96 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
器时)，同时大家也可以看到，代码片段或者说逻辑控制流的调度和切换其实并不神秘，理论上，我们也
:::

::: {.t .m0 .x1 .h3 .y97 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
可以不依赖操作系统和其提供的线程，在自己程序的代码段里定义多个片段，然后在我们自己程序里对其
:::

::: {.t .m0 .x1 .h3 .y98 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
进行调度和切换。
:::

::: {.t .m0 .x1 .h3 .y99 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
为了描述方便，我们接下来把"代码片段"称为"任务"。
:::

::: {.t .m0 .x1 .h3 .y9a .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
和内核的实现类似，只是我们不需要考虑中断和系统调用，那么，我们的程序本质上就是一个循环，这个
:::

::: {.t .m0 .x1 .h3 .y9b .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
循环本身就是调度程序schedule()，我们需要维护一个任务的列表，根据我们定义的策略，先进先出或
:::

::: {.t .m0 .x1 .h3 .y9c .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
是有优先级等等，每次从列表里挑选出一个任务，然后恢复各个寄存器的值，并且JMP到该任务上次被
:::

::: {.t .m0 .x1 .h3 .y9d .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
暂停的地方，所有这些需要保存的信息都可以作为该任务的属性，存放在任务列表里。
:::

::: {.t .m0 .x1 .h3 .y9e .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
看起来很简单啊，可是我们还需要解决几个问题：
:::

::: {.t .m0 .x1 .h3 .y9f .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
(1)我们运行在用户态，是没有中断或系统调用这样的机制来打断代码执行的，那么，一旦我们的
:::

::: {.t .m0 .x1 .h3 .ya0 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
schedule()代码把控制权交给了任务的代码，我们下次的调度在什么时候发生？答案是，不会发生，只
:::

::: {.t .m0 .x1 .h3 .ya1 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
有靠任务主动调用schedule()，我们才有机会进行调度，所以，这里的任务不能像线程一样依赖内核调度
:::

::: {.t .m0 .x1 .h3 .ya2 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
从而毫无顾忌的执行，我们的任务里一定要显式的调用schedule()，这就是所谓的协作式(cooperative)
:::
:::

[](http://lxr.linux.no/linux+v3.8.2/arch/x86/include/asm/switch_to.h#L31){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:449.951570px;bottom:758.232910px;width:46.523470px;height:14.257080px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://lxr.linux.no/linux+v3.8.2/kernel/sched/core.c#L2845){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:119.034790px;bottom:614.160160px;width:51.776090px;height:14.257320px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://linux.die.net/man/2/sched_yield){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:296.874420px;bottom:614.160160px;width:64.532530px;height:14.257320px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://lwn.net/Articles/80911/){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:259.355530px;bottom:434.069580px;width:100.550660px;height:14.257080px;background-color:rgba(255,255,255,0.000001);"}
:::
:::

::: {.pi data="{\"ctm\":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}"}
:::
:::

::: {#pf5 .pf .w0 .h0 page-no="5"}
::: {.pc .pc5 .w0 .h0}
![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+AAAAXLCAIAAAAz/kHlAAAACXBIWXMAABYlAAAWJQFJUiTwAAAY1UlEQVR42uzWMQEAAAjDMMC/580GRyKhVzfJAAAAP5wEAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMugQAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAy6BAAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADLoEAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMugQAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAy6BAAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoQNutYwEAAACAQf7Ws9hVFAEACDoAACDoAAAg6AAAgKADAICgAwAAgg4AAIIOAAAIOgAACDoAACDoAAAg6AAAgKADAICgAwAAgg4AAAg6AAAIOgAAIOgAACDoAACAoAMAgKADAACCDgAAgg4AAAg6AAAIOgAAIOgAACDoAACAoAMAAIIOAACCDgAACDoAAAg6AAAg6AAAIOgAAICgAwCAoAMAAIIOAACCDgAACDoAAAg6AAAg6AAAgKADAICgAwAAgg4AAIIOAAAIOgAACDoAACDoAAAg6AAAgKADAICgAwAAgg4AAIIOAAAIOgAAIOgAACDoAACAoAMAgKADAACCDgAAgg4AAAg6AAAIOgAAIOgAACDoAADALoyVDpMph755AAAAAElFTkSuQmCC){.bi
.x0 .y0 .w1 .h1}

::: {.c .x0 .y52 .w1 .h5}
::: {.t .m0 .x1 .h3 .ya3 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
调度。(虽然我们可以通过注册信号处理函数来模拟内核里的时钟中断并取得控制权，可问题在于，信号
:::

::: {.t .m0 .x1 .h3 .ya4 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
处理函数是由内核调用的，在其结束的时候，内核重新获得控制权，随后返回用户态并继续沿着信号发
:::

::: {.t .m0 .x1 .h3 .ya5 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
生时被中断的代码路径执行，从而我们无法在信号处理函数内进行任务切换)
:::

::: {.t .m0 .x1 .h3 .ya6 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
(2)堆栈。和内核调度线程的原理一样，我们也需要为每个任务单独分配堆栈，并且把其堆栈信息保存在
:::

::: {.t .m0 .x1 .h3 .ya7 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
任务属性里，在任务切换时也保存或恢复当前的SS:ESP。任务堆栈的空间可以是在当前线程的堆栈上分
:::

::: {.t .m0 .x1 .h3 .ya8 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
配，也可以是在堆上分配，但通常是在堆上分配比较好：几乎没有大小或任务总数的限制、堆栈大小可以
:::

::: {.t .m0 .x1 .h3 .ya9 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
动态扩展(gcc有splitstack，但太复杂了)、便于把任务切换到其他线程。
:::

::: {.t .m0 .x1 .h3 .yaa .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
到这里，我们大概知道了如何构造一个并发的编程框架，可如何让任务可以并行的在多个逻辑处理器上执
:::

::: {.t .m0 .x1 .h3 .yab .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
行呢？只有内核才有调度CPU的权限，所以，我们还是必须通过系统调用创建线程，才可以实现并行。在
:::

::: {.t .m0 .x1 .h3 .yac .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
多线程处理多任务的时候，我们还需要考虑几个问题：
:::

::: {.t .m0 .x1 .h3 .yad .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
(1)如果某个任务发起了一个系统调用，譬如长时间等待IO，那当前线程就被内核放入了等待调度的队
:::

::: {.t .m0 .x1 .h3 .yae .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
列，岂不是让其他任务都没有机会执行？
:::

::: {.t .m0 .x1 .h3 .yaf .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
在单线程的情况下，我们只有一个解决办法，就是使用非阻塞的IO系统调用，并让出CPU，然后在
:::

::: {.t .m0 .x1 .h3 .yb0 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
schedule()里统一进行轮询，有数据时切换回该fd对应的任务；效率略低的做法是不进行统一轮询，让
:::

::: {.t .m0 .x1 .h3 .yb1 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
各个任务在轮到自己执行时再次用非阻塞方式进行IO，直到有数据可用。
:::

::: {.t .m0 .x1 .h3 .yb2 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
如果我们采用多线程来构造我们整个的程序，那么我们可以封装系统调用的接口，当某个任务进入系统调
:::

::: {.t .m0 .x1 .h3 .yb3 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
用时，我们就把当前线程留给它(暂时)独享，并开启新的线程来处理其他任务。
:::

::: {.t .m0 .x1 .h3 .yb4 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
(2)任务同步。譬如我们上节提到的生产者和消费者的例子，如何让消费者在数据还没有被生产出来的时
:::

::: {.t .m0 .x1 .h3 .yb5 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
候进入等待，并且在数据可用时触发消费者继续执行呢？
:::

::: {.t .m0 .x1 .h3 .yb6 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
在单线程的情况下，我们可以定义一个结构，其中有变量用于存放交互数据本身，以及数据的当前可用状
:::

::: {.t .m0 .x1 .h3 .yb7 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
态，以及负责读写此数据的两个任务的编号。然后我们的并发编程框架再提供read和write方法供任务调
:::

::: {.t .m0 .x1 .h3 .yb8 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
用，在read方法里，我们循环检查数据是否可用，如果数据还不可用，我们就调用schedule()让出CPU
:::

::: {.t .m0 .x1 .h3 .yb9 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
进入等待；在write方法里，我们往结构里写入数据，更改数据可用状态，然后返回；在schedule()里，
:::

::: {.t .m0 .x1 .h3 .yba .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
我们检查数据可用状态，如果可用，则激活需要读取此数据的任务，该任务继续循环检测数据是否可
:::

::: {.t .m0 .x1 .h3 .ybb .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
用，发现可用，读取，更改状态为不可用，返回。代码的简单逻辑如下：
:::

::: {.t .m0 .x1 .h3 .ybc .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
structchan{
:::

::: {.t .m0 .x1 .h3 .ybd .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
boolready,
:::

::: {.t .m0 .x1 .h3 .ybe .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
intdata
:::

::: {.t .m0 .x1 .h3 .ybf .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
};
:::

::: {.t .m0 .x1 .h3 .yc0 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
intread(structchan\*c){
:::

::: {.t .m0 .x1 .h3 .yc1 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
while(1){
:::

::: {.t .m0 .x1 .h3 .yc2 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
if(c-\>ready){
:::

::: {.t .m0 .x1 .h3 .yc3 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
c-\>ready=false;
:::

::: {.t .m0 .x1 .h3 .yc4 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
returnc-\>data;
:::

::: {.t .m0 .x1 .h3 .yc5 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}else{
:::

::: {.t .m0 .x1 .h3 .yc6 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
schedule();
:::

::: {.t .m0 .x1 .h3 .yc7 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}
:::

::: {.t .m0 .x1 .h3 .yc8 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}
:::

::: {.t .m0 .x1 .h3 .yc9 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}
:::
:::
:::

::: {.pi data="{\"ctm\":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}"}
:::
:::

::: {#pf6 .pf .w0 .h0 page-no="6"}
::: {.pc .pc6 .w0 .h0}
![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+AAAAXLCAIAAAAz/kHlAAAACXBIWXMAABYlAAAWJQFJUiTwAAAZaUlEQVR42uzasW3EMBBEUdNgU6yNMWtjWePUoQ5n4lbye7GiSfS1UEvyBQAA1PBtAgAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAt0EAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEugkAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAwBHdBM/QxjICcEX2NAJAZS7oAABQSEtiBQAAKMIF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AAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0EwAAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAgLd0EwDntLGMwJ/InkYA/svbM4kVAACgCL+4AACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBAh5927ZgGABAIgmBIMIU2arQh67BAQQFkRsIVny0eAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwAAgQ4AAAh0AAAQ6AAAgEAHAACBDgAACHQAAECgAwCAQAcAAAQ6AAAIdAAAQKADAIBABwAABDoAAAh0AABAoAMAgEAHAAAEOgAACHQAAECgAwAAAh0AAAQ6AAAg0AEAQKADAAACHQAABDoAACDQAQBAoAMAAAIdAAAEOgAAINABAECgAwAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQCAk6oJAB5S2jDCvsxuBOC9U5/ECgAAcAkvLgAAINABAACBDgAAAh0AABDoAAAg0AEAAIEOAAACHQAAEOgAACDQAQAAgQ4AAAIdAAAQ6AAAgEAHAACBDgAACHQAABDoAACAQAcAAIEOAAAIdAAAEOgAAIBABwCAny1qTDiFUPNb3wAAAABJRU5ErkJggg==){.bi
.x0 .y0 .w1 .h1}

::: {.c .x0 .y52 .w1 .h5}
::: {.t .m0 .x1 .h3 .yca .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
voidwrite(structchan\*c,inti){
:::

::: {.t .m0 .x1 .h3 .ycb .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
while(1){
:::

::: {.t .m0 .x1 .h3 .ycc .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
if(c-\>ready){
:::

::: {.t .m0 .x1 .h3 .ycd .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
schedule();
:::

::: {.t .m0 .x1 .h3 .yce .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}else{
:::

::: {.t .m0 .x1 .h3 .ycf .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
c-\>data=i;
:::

::: {.t .m0 .x1 .h3 .yd0 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
c-\>ready=true;
:::

::: {.t .m0 .x1 .h3 .yd1 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
schedule();//optional
:::

::: {.t .m0 .x1 .h3 .yd2 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
return;
:::

::: {.t .m0 .x1 .h3 .yd3 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}
:::

::: {.t .m0 .x1 .h3 .yd4 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}
:::

::: {.t .m0 .x1 .h3 .yd5 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
}
:::

::: {.t .m0 .x1 .h3 .yd6 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
很显然，如果是多线程的话，我们需要通过线程库或系统调用提供的同步机制来保护对这个结构体内数据
:::

::: {.t .m0 .x1 .h3 .yd7 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的访问。
:::

::: {.t .m0 .x1 .h3 .yd8 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
以上就是最简化的一个并发框架的设计考虑，在我们实际开发工作中遇到的并发框架可能由于语言和运行
:::

::: {.t .m0 .x1 .h3 .yd9 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
库的不同而有所不同，在功能和易用性上也可能各有取舍，但底层的原理都是殊途同归。
:::

::: {.t .m0 .x1 .h3 .yda .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
譬如，glic里的[getcontext/setcontext/swapcontext]{.fc0}系列库函数可以方便的用来保存和恢复任务执行状
:::

::: {.t .m0 .x1 .h3 .ydb .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
态；Windows提供了Fiber系列的SDKAPI；这二者都不是系统调用，[getcontext和setcontext]{.fc0}的man
:::

::: {.t .m0 .x1 .h3 .ydc .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
page虽然是在section2，但那只是SVR4时的历史遗留问题，其实现代码是在glibc而不是kernel；
:::

::: {.t .m0 .x1 .h3 .ydd .ff1 .fs0 .fc0 .sc0 .ls0 .ws0}
CreateFiber[.aspx)是在kernel32里提供的，NTDLL里并没有对应的NtCreateFiber。]{.fc1}
:::

::: {.t .m0 .x1 .h3 .yde .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
在其他语言里，我们所谓的"任务"更多时候被称为"协程"，也就是Coroutine。譬如C++里最常用的
:::

::: {.t .m0 .x1 .h3 .ydf .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
是Boost.Coroutine；Java因为有一层字节码解释，比较麻烦，但也有支持协程的JVM补丁，或是动态
:::

::: {.t .m0 .x1 .h3 .ye0 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
修改字节码以支持协程的项目；PHP和Python的generator和yield其实已经是协程的支持，在此之上可
:::

::: {.t .m0 .x1 .h3 .ye1 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
以封装出更通用的协程接口和调度；另外还有原生支持协程的Erlang等，笔者不懂，就不说了，具体可
:::

::: {.t .m0 .x1 .h3 .ye2 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
参见Wikipedia的页面：[http://en.wikipedia.org/wiki/Coroutine]{.fc0}
:::

::: {.t .m0 .x1 .h3 .ye3 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
由于保存和恢复任务执行状态需要访问CPU寄存器，所以相关的运行库也都会列出所支持的CPU列表。
:::

::: {.t .m0 .x1 .h3 .ye4 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
从操作系统层面提供协程以及其并行调度的，好像只有OSX和iOS的[GrandCentralDispatch]{.fc0}，其大部
:::

::: {.t .m0 .x1 .h3 .ye5 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
分功能也是在运行库里实现的。
:::

::: {.t .m0 .x1 .h4 .ye6 .ff2 .fs1 .fc1 .sc0 .ls0 .ws0}
5.goroutine
:::

::: {.t .m0 .x1 .h3 .ye7 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
Go语言通过goroutine提供了目前为止所有(我所了解的)语言里对于并发编程的最清晰最直接的支持，
:::

::: {.t .m0 .x1 .h3 .ye8 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
Go语言的文档里对其特性也描述的非常全面甚至超过了，在这里，基于我们上面的系统知识介绍，列举
:::

::: {.t .m0 .x1 .h3 .ye9 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
一下goroutine的特性，算是小结：
:::

::: {.t .m0 .x2 .h3 .yea .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
10[]{._ ._1}.[]{._
._2}goroutine是Go语言运行库的功能，不是操作系统提供的功能，goroutine不是用线程实现
:::

::: {.t .m0 .x2 .h3 .yeb .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
的。具体可参见Go语言源码里的[pkg/runtime/proc.c]{.fc0}
:::

::: {.t .m0 .x2 .h3 .yec .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
11[]{._ ._1}.[]{._
._2}goroutine就是一段代码，一个函数入口，以及在堆上为其分配的一个堆栈。所以它非常廉
:::

::: {.t .m0 .x2 .h3 .yed .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
价，我们可以很轻松的创建上万个goroutine，但它们并不是被操作系统所调度执行
:::

::: {.t .m0 .x2 .h3 .yee .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
12[]{._ ._1}.[]{._
._2}除了被系统调用阻塞的线程外，Go运行库最多会启动\$GOMAXPROCS个线程来运行
:::

::: {.t .m0 .x2 .h3 .yef .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
goroutine
:::

::: {.t .m0 .x2 .h3 .yf0 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
13[]{._ ._1}.[]{._
._2}goroutine是协作式调度的，如果goroutine会执行很长时间，而且不是通过等待读取或写入
:::

::: {.t .m0 .x2 .h3 .yf1 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
channel的数据来同步的话，就需要主动调用[Gosched()]{.fc0}来让出CPU
:::
:::

[](http://linux.die.net/man/3/swapcontext){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:125.788200px;bottom:488.096680px;width:178.590000px;height:14.257320px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://linux.die.net/man/2/getcontext){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:378.665650px;bottom:470.087650px;width:116.308620px;height:14.257080px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://msdn.microsoft.com/en-us/library/windows/desktop/ms682402%28v=vs.85){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:56.003025px;bottom:434.069580px;width:57.779125px;height:14.257080px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://en.wikipedia.org/wiki/Coroutine){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:169.310130px;bottom:344.023930px;width:193.597580px;height:14.257320px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://developer.apple.com/library/ios/#documentation/Performance/Reference/GCD_libdispatch_Ref/Reference/reference.html){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:371.161870px;bottom:308.005860px;width:117.058990px;height:14.257320px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://golang.org/src/pkg/runtime/proc.c){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:236.844180px;bottom:168.435550px;width:98.299530px;height:14.257320px;background-color:rgba(255,255,255,0.000001);"}
:::

[](http://golang.org/pkg/runtime/#Gosched){.l}

::: {.d .m1 style="border-style:none;position:absolute;left:293.122530px;bottom:60.381348px;width:51.025720px;height:14.256836px;background-color:rgba(255,255,255,0.000001);"}
:::
:::

::: {.pi data="{\"ctm\":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}"}
:::
:::

::: {#pf7 .pf .w0 .h0 page-no="7"}
::: {.pc .pc7 .w0 .h0}
![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+AAAAHgCAIAAACq2pADAAAACXBIWXMAABYlAAAWJQFJUiTwAAAIGklEQVR42u3WMQEAAAjDMMC/5/GjgCOR0KudpAAAgB9GAgAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABl0CAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAAMCgAwCAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwAABh0AAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AADDoAABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAACAQQcAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAAw6AAAYdAAAwKADAIBBBwAADDoAABh0AADAoAMAgEEHAAAMOgAAGHQAAMCgAwCAQQcAAAw6AABg0AEAwKADAAAGHQAADDoAAGDQAQDAoAMAAAYdAAAMOgAAYNABAMCgAwAABh0AAAw6AABg0AEAAIMOAAAGHQAAMOgAAGDQAQAAgw4AAAYdAAAw6AAAYNABAACDDgAABh0AADDoAABg0AEAAIMOAAAYdAAAMOgAAIBBBwAAgw4AABh0AAAw6AAAgEEHAACDDgAAGHQAADDoAACAQQcAAIMOAAAYdAAA4Fo6gAa9L0Wr2AAAAABJRU5ErkJggg==){.bi
.x0 .yf2 .w1 .h7}

::: {.c .x0 .yf3 .w1 .h8}
::: {.t .m0 .x2 .h3 .yf4 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
14[]{._ ._1}.[]{._
._2}和所有其他并发框架里的协程一样，goroutine里所谓"无锁"的优点只在单线程下有效，如
:::

::: {.t .m0 .x2 .h3 .yf5 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
果\$GOMAXPROCS\>1并且协程间需要通信，Go运行库会负责加锁保护数据，这也是为什么
:::

::: {.t .m0 .x2 .h3 .yf6 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
sieve.go这样的例子在多CPU多线程时反而更慢的原因
:::

::: {.t .m0 .x2 .h3 .yf7 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
15[]{._ ._1}.[]{._
._2}Web等服务端程序要处理的请求从本质上来讲是并行处理的问题，每个请求基本独立，互不依
:::

::: {.t .m0 .x2 .h3 .yf8 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
赖，几乎没有数据交互，这不是一个并发编程的模型，而并发编程框架只是解决了其语义表述的
:::

::: {.t .m0 .x2 .h3 .yf9 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
复杂性，并不是从根本上提高处理的效率，也许是并发连接和并发编程的英文都是concurrent吧，
:::

::: {.t .m0 .x2 .h3 .yfa .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
很容易产生"并发编程框架和coroutine可以高效处理大量并发连接"的误解。
:::

::: {.t .m0 .x2 .h3 .yfb .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
16[]{._ ._1}.[]{._
._2}Go语言运行库封装了异步IO，所以可以写出貌似并发数很多的服务端，可即使我们通过调整
:::

::: {.t .m0 .x2 .h3 .yfc .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
\$GOMAXPROCS来充分利用多核CPU并行处理，其效率也不如我们利用IO事件驱动设计的、按照
:::

::: {.t .m0 .x2 .h3 .yfd .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
事务类型划分好合适比例的线程池。在响应时间上，协作式调度是硬伤。
:::

::: {.t .m0 .x2 .h3 .yfe .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
17[]{._ ._1}.[]{._
._2}goroutine最大的价值是其实现了并发协程和实际并行执行的线程的映射以及动态扩展，随着
:::

::: {.t .m0 .x2 .h3 .yff .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
其运行库的不断发展和完善，其性能一定会越来越好，尤其是在CPU核数越来越多的未来，终有一
:::

::: {.t .m0 .x2 .h3 .y100 .ff1 .fs0 .fc1 .sc0 .ls0 .ws0}
天我们会为了代码的简洁和可维护性而放弃那一点点性能的差别。
:::
:::
:::

::: {.pi data="{\"ctm\":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}"}
:::
:::
:::

::: {.loading-indicator}
![](data:image/png;base64,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)
:::
